SELECT T1.COMPANY,
  T1.PERSON_ID,
  T1.CALMONTH,
  T2.PERSON_ID AS THISMONTHPAYDEBT,
  T3.PERSON_ID AS LASTMONTHPAYDEBT,
  T4.PERSON_ID AS LASTPAYDEBT,
  T5.PERSON_ID AS FIRSTPAY
FROM (((CRM_GONE_RETURN_PRE_COMPERCAL_FULLJOIN AS T1
      LEFT JOIN CRM_GONE_RETURN_PRE_PAYMENT_DEBT_DISTINCT AS T2
                ON (T1.COMPANY = T2.COMPANY AND T1.PERSON_ID = T2.PERSON_ID AND T1.CALMONTH = T2.PAYMONTH))
      LEFT JOIN CRM_GONE_RETURN_PRE_PAYMENT_DEBT_DISTINCT AS T3
                ON (T1.COMPANY = T3.COMPANY AND T1.PERSON_ID = T3.PERSON_ID AND T1.CALMONTH = DATEADD('m', 1, T3.PAYMONTH)))
      LEFT JOIN (SELECT COMPANY, PERSON_ID, MAX(PAYMONTH) AS LAST_PAYDEBTMONTH FROM CRM_GONE_RETURN_PRE_PAYMENT_DEBT_DISTINCT GROUP BY COMPANY, PERSON_ID) AS T4
                ON (T1.COMPANY = T4.COMPANY AND T1.PERSON_ID = T4.PERSON_ID AND T1.CALMONTH = DATEADD('m', 1, T4.LAST_PAYDEBTMONTH)))
      LEFT JOIN (SELECT CRM1.COMPANY, CRM1.PERSON_ID, CRM1.FIRST_PAYDEBTMONTH FROM (SELECT COMPANY, PERSON_ID, MIN(PAYMONTH) AS FIRST_PAYDEBTMONTH FROM CRM_GONE_RETURN_PRE_PAYMENT_DEBT_DISTINCT GROUP BY COMPANY, PERSON_ID) AS CRM1 INNER JOIN PERSON ON PERSON.PERSON_ID = CRM1.PERSON_ID WHERE PERSON.INFOSOURCE <> 'Старый клиент') AS T5
                ON (T1.COMPANY = T5.COMPANY AND T1.PERSON_ID = T5.PERSON_ID AND T1.CALMONTH = T5.FIRST_PAYDEBTMONTH)
